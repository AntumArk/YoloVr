services:
  # Linux native build service
  linux-builder:
    build:
      context: .
      dockerfile: Dockerfile.linux-builder
    volumes:
      - .:/workspace
      - linux-build-cache:/workspace/build-linux
    working_dir: /workspace
    command: >
      /bin/bash -c "
      mkdir -p build-linux &&
      cd build-linux &&
      cmake ../driver &&
      make -j$$(nproc)
      "

  # Interactive Linux development container
  linux-dev:
    build:
      context: .
      dockerfile: Dockerfile.linux-builder
    volumes:
      - .:/workspace
      - linux-build-cache:/workspace/build-linux
    working_dir: /workspace
    stdin_open: true
    tty: true
    command: /bin/bash

  # Windows cross-compilation build service
  windows-builder:
    build:
      context: .
      dockerfile: Dockerfile.windows-builder
    volumes:
      - .:/workspace
      - windows-build-cache:/workspace/build-windows
    working_dir: /workspace
    environment:
      - CMAKE_TOOLCHAIN_FILE=/workspace/cmake/windows-toolchain.cmake
    command: >
      /bin/bash -c "
      mkdir -p build-windows &&
      cd build-windows &&
      cmake -DCMAKE_TOOLCHAIN_FILE=../cmake/windows-toolchain.cmake ../driver &&
      make -j$$(nproc)
      "

  # Interactive Windows development container
  windows-dev:
    build:
      context: .
      dockerfile: Dockerfile.windows-builder
    volumes:
      - .:/workspace
      - windows-build-cache:/workspace/build-windows
    working_dir: /workspace
    stdin_open: true
    tty: true
    command: /bin/bash

volumes:
  linux-build-cache:
  windows-build-cache: